<div class="d-flex row justify-content-center align-items-center m-5">
  <div class="col-md-4" style="flex: 0 0 auto">
    <app-friends-list (selectedUser)="onSelectUser($event)" />
  </div>

  <!-- chatbox -->
  <div class="col-md-8 ps-5 d-none d-md-block" style="flex: 1 1 0">
    <div
      class="chat-box d-flex flex-column justify-content-between subcontainer shadow-lg mx-3"
    >
      @if (selectedUser()) {
        <div class="d-flex justify-content-between p-2">
          <div>
            <span
              ><img
                class="profile-image"
                [src]="selectedUser()?.friend?.image_url"
                alt="image"
            /></span>
            <span class="ms-3 fs-4" style="vertical-align: middle"
              >{{ selectedUser()?.friend?.first_name }}
              {{ selectedUser()?.friend?.last_name }}</span
            >
          </div>
          <button
            class="vertical-dots d-flex flex-column me-2 btn"
            id="dropdownMenuButton1"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li>
              <button
                class="dropdown-item"
                (click)="viewExpense(selectedUser()!.conversation_id)"
              >
                View Expenses
              </button>
            </li>
            <li>
              <button
                class="dropdown-item"
                (click)="
                  archiveBlock(selectedUser()!.conversation_id, 'archived')
                "
              >
                {{ getArchiveLabel() }}
              </button>
            </li>
            <li>
              <button
                class="dropdown-item"
                (click)="
                  archiveBlock(selectedUser()!.conversation_id, 'blocked')
                "
              >
                {{ getBlockLabel() }}
              </button>
            </li>
          </ul>
        </div>
        <hr class="m-0" />

        <div  #messageContainer [scrollTop]="messageContainer.scrollHeight"
          class="message-body flex-grow-1 row p-0 m-0"
          style="max-height: 57vh; overflow-y: auto;"
        >
          <div
            class="message-body col-md-12 col-lg-12 col-xl-12"
            style="height: 100%"
          >
            <ul 
            class="message-body list-unstyled text-white m-0">
              @for (message of messages(); track message.message_id) {
                @if (message.sender_id !== user?.user_id) {
                  <li class="d-flex justify-content-start mb-1 px-2">
                    <img
                      [src]="selectedUser()?.friend?.image_url"
                      alt="avatar"
                      class="rounded-circle d-inline-flex align-self-end me-3 shadow-1-strong"
                      width="40"
                    />
                    <div
                      class="card"
                      style="
                        background: rgba(24, 24, 16, 0.2);
                        border-radius: 2em;
                        backdrop-filter: blur(15px);
                        border: 2px solid rgba(255, 255, 255, 0.05);
                        background-clip: padding-box;
                        box-shadow: 10px 10px 10px rgba(46, 54, 68, 0.03);
                      "
                    >
                      <div
                        class="card-header d-flex justify-content-start px-4"
                        style="
                          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                          background: transparent;
                        "
                      >
                        <p class="fw-bold mb-0">
                          {{ selectedUser()?.friend?.first_name }}
                        </p>
                      </div>
                      <div class="card-body px-4">
                        <p class="mb-0">{{ message.message }}</p>
                      </div>
                    </div>
                  </li>
                } @else {
                  <li class="d-flex justify-content-end mb-1 px-2">
                    <div
                      class="card w"
                      style="
                        background: rgba(24, 24, 16, 0.2);
                        border-radius: 2em;
                        backdrop-filter: blur(15px);
                        border: 2px solid rgba(255, 255, 255, 0.05);
                        background-clip: padding-box;
                        box-shadow: 10px 10px 10px rgba(46, 54, 68, 0.03);
                      "
                    >
                      <div
                        class="card-header d-inline-flex justify-content-end px-4"
                        style="
                          border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                          background: transparent;
                        "
                      >
                        <p class="fw-bold mb-0">You</p>
                      </div>
                      <div
                        class="card-body d-inline-flex justify-content-end px-4"
                      >
                        <p class="justify-content-end mb-0">
                          {{ message.message }}
                        </p>
                      </div>
                    </div>
                    <img
                      [src]="user?.image_url"
                      alt="avatar"
                      class="rounded-circle d-inline-flex align-self-end ms-3 shadow-1-strong"
                      width="40"
                    />
                  </li>
                }
              }
            </ul>
          </div>
        </div>

        <hr class="m-0" />
        @if (selectedUser()?.block_status === "NONE") {
          <div
            class="d-flex input-container justify-content-around align-items-center mx-3"
          >
            <div class="custom-width">
              <button class="btn btn-success w-100" (click)="openAddExpenseDialog()">Add Expense</button>
            </div>
            <div class="input-field ms-3">
              <input
                class="message-input"
                [(ngModel)]="messageInput"
                (keyup.enter)="sendMessage()"
                style="width: 100%"
                type="text"
                class="form-control"
                placeholder="Type something..."
              />
            </div>
            <button (click)="sendMessage()" class="send-message m-3">
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
        } @else {
          <div
            class="d-flex input-container justify-content-around align-items-center mx-3"
            style="flex: 1 1 0"
          >
            <div class="custom-width disabled-pointer">
              <button class="btn btn-success w-100 disabled-pointer"  disabled>
                Add Expense
              </button>
            </div>
            <div class="input-field disabled-pointer ms-3">
              <input
                class="message-input disabled-pointer"
                disabled
                style="width: 100%; cursor: not-allowed !important"
                type="text"
                class="form-control"
                placeholder="Type something..."
              />
            </div>
            <button class="send-message m-3 disabled-pointer" disabled>
              <i class="fa fa-paper-plane"></i>
            </button>
          </div>
        }
      } @else {
        <div class="text-center p-2" style="flex: 1 1 0">
          <h1
            class="pt-2"
            style="color: linear-gradient(to left, #87ceeb, #a0d3e8, #90ee90)"
          >
            Welcome, <span>{{ user_name }}!</span>
          </h1>
          <img class="chat-box-image" src="robot.gif" alt="robot" />
          <h3 class="pb-2">Please select a chat to start messaging</h3>
        </div>
      }
    </div>
  </div>
</div>
