<div class="d-flex row justify-content-center align-items-center m-5">
  <div class="col-md-4" style="flex: 0 0 auto">
    <app-groups-list
      (selectedGroup)="onSelectGroup($event)"
      [balanceAmount]="selectedGroup()?.balance_amount || '0'"
    />
  </div>

  <!-- chatbox -->
  <div
    class="col-md-8 ps-md-5 d-md-block"
    [ngClass]="{ 'd-none': !selectedGroup }"
    style="flex: 1 1 0"
  >
    <div
      class="chat-box d-flex flex-column justify-content-between subcontainer shadow-lg mx-3"
    >
      @if (selectedGroup()) {
        <div class="d-flex justify-content-between align-items-center p-2">
          <div>
            <span
              class="material-icons pe-2"
              style="vertical-align: middle"
              (click)="clearSelectedGroupData()"
            >
              arrow_back
            </span>
            <span
              ><img
                class="profile-image"
                [src]="selectedGroup()?.image_url ?? '/group-profile.png'"
                alt="Group"
                (click)="openGroupDetails()"
                (keyup.enter)="openGroupDetails()"
                style="cursor: pointer"
            /></span>
            <span
              class="ms-3 fs-4"
              style="vertical-align: middle"
              (click)="openGroupDetails()"
              (keyup.enter)="openGroupDetails()"
              style="cursor: pointer"
              >{{ selectedGroup()?.group_name }}</span
            >
          </div>
          <div class="d-flex align-items-center">
            <div class="dropdown pe-3">
              <button
                class="btn btn-secondary dropdown-toggle"
                type="button"
                id="dropdownMenuButton2"
                data-bs-toggle="dropdown"
              >
                {{ currentView() }}
              </button>
              <ul class="dropdown-menu">
                <li>
                  <button class="dropdown-item" (click)="toggleView('All')">
                    All
                  </button>
                </li>
                <li>
                  <button
                    class="dropdown-item"
                    (click)="toggleView('Messages')"
                  >
                    Messages
                  </button>
                </li>
                <li>
                  <button
                    class="dropdown-item"
                    (click)="toggleView('Expenses')"
                  >
                    Expenses
                  </button>
                </li>
              </ul>
            </div>
            <button
              class="vertical-dots d-flex flex-column me-2 btn"
              id="dropdownMenuButton1"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </button>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
              <li>
                <button class="dropdown-item" (click)="openGroupDetails()">
                  Group Details
                </button>
              </li>
              @if (selectedGroup()?.role !== "USER") {
                <li>
                  <button class="dropdown-item" (click)="onAddMembers()">
                    Add Members
                  </button>
                </li>
              }
              <li>
                <button class="dropdown-item" (click)="openGroupDetails()">
                  Settle Up
                </button>
              </li>
              <li>
                <button class="dropdown-item" (click)="onBlockGroup()">
                  {{ selectedGroup()?.has_blocked ? "Unblock" : "Block" }} Group
                </button>
              </li>
              <li>
                <button class="dropdown-item" (click)="onLeaveGroup()">
                  Leave Group
                </button>
              </li>
            </ul>
          </div>
        </div>
        <hr class="m-0" />

        <div
          #messageContainer
          (scroll)="onScroll($event)"
          class="message-body flex-grow-1 row p-0 m-0"
          [ngClass]="loading ? 'loading' : ''"
          style="max-height: 57vh; overflow-y: auto"
        >
          <div
            class="message-body col-md-12 col-lg-12 col-xl-12"
            style="height: 100%"
          >
            <ul class="message-body list-unstyled text-white m-0">
              @if (currentView() === "Messages") {
                @for (message of messages(); track message.group_message_id) {
                  <app-message
                    [message]="{
                      sender_id: message.sender_id,
                      message: message.message,
                      createdAt: message.createdAt,
                      updatedAt: message.updatedAt,
                    }"
                    [currentUserId]="currentMember()?.group_membership_id"
                    [imageUrl]="message.senderImage"
                    [name]="message.senderName"
                    [currentUserImageUrl]="user?.image_url"
                  >
                  </app-message>
                }
              } @else if (currentView() === "Expenses") {
                @for (expense of expenses(); track $index) {
                  @if (isGroupExpense(expense)) {
                    <app-expense
                      [expense]="{
                        expense_id: expense.group_expense_id,
                        expense_name: expense.expense_name,
                        total_amount: expense.total_amount,
                        debtor_amount: expense.payer_id === currentMember()?.group_membership_id ? expense.total_debt_amount : expense.user_debt,
                        payer_id: expense.payer_id,
                        createdAt: expense.createdAt,
                        updatedAt: expense.updatedAt,
                      }"
                      [currentUserId]="currentMember()?.group_membership_id"
                      [imageUrl]="expense.payer.imageUrl"
                      [name]="expense.payer.fullName"
                      [currentUserImageUrl]="currentMember()?.image_url"
                    >
                    </app-expense>
                  } @else {
                    <app-settlement-display
                      [settlement]="{
                        settlement_id: expense.group_settlement_id,
                        settlement_amount: expense.settlement_amount,
                        payerId: expense.payer_id,
                        debtorId: expense.debtor_id,
                        description: expense.description,
                        createdAt: expense.createdAt,
                        updatedAt: expense.updatedAt,
                      }"
                      [currentUserId]="currentMember()?.group_membership_id"
                      [payerName]="expense.payer.fullName"
                      [currentUserImageUrl]="currentMember()?.image_url"
                      [payerImageUrl]="expense.payer.imageUrl"
                      [debtorName]="expense.debtor.fullName"
                      [debtorImageUrl]="expense.debtor.imageUrl"
                    ></app-settlement-display>
                  }
                }
              } @else {
                @for (item of combinedView(); track $index) {
                  @if (isCombinedMessage(item)) {
                    <app-message
                      [message]="{
                        sender_id: item.sender_id,
                        message: item.message,
                        createdAt: item.createdAt,
                        updatedAt: item.updatedAt,
                      }"
                      [currentUserId]="currentMember()?.group_membership_id"
                      [imageUrl]="item.senderImage"
                      [name]="item.senderName"
                      [currentUserImageUrl]="user?.image_url"
                    >
                    </app-message>
                  } @else if (isCombinedExpense(item)) {
                    <app-expense
                      [expense]="{
                        expense_id: item.group_expense_id,
                        expense_name: item.expense_name,
                        total_amount: item.total_amount,
                        debtor_amount: item.payer_id === currentMember()?.group_membership_id ? item.total_debt_amount : item.user_debt,
                        payer_id: item.payer_id,
                        createdAt: item.createdAt,
                        updatedAt: item.updatedAt,
                      }"
                      [currentUserId]="currentMember()?.group_membership_id"
                      [imageUrl]="item.payer.imageUrl"
                      [name]="item.payer.fullName"
                      [currentUserImageUrl]="currentMember()?.image_url"
                    >
                    </app-expense>
                  } @else if (isCombinedSettlement(item)) {
                    <app-settlement-display
                      [settlement]="{
                        settlement_id: item.group_settlement_id,
                        settlement_amount: item.settlement_amount,
                        payerId: item.payer_id,
                        debtorId: item.debtor_id,
                        description: item.description,
                        createdAt: item.createdAt,
                        updatedAt: item.updatedAt,
                      }"
                      [currentUserId]="currentMember()?.group_membership_id"
                      [payerName]="item.payer.fullName"
                      [currentUserImageUrl]="currentMember()?.image_url"
                      [payerImageUrl]="item.payer.imageUrl"
                      [debtorName]="item.debtor.fullName"
                      [debtorImageUrl]="item.debtor.imageUrl"
                    ></app-settlement-display>
                  }
                }
              }
            </ul>
          </div>
        </div>

        <hr class="m-0" />
        <div
          class="d-flex input-container justify-content-around align-items-center mx-3"
        >
          <div class="custom-width">
            <button
              [disabled]="addExpenseLoader"
              (click)="openAddExpenseDialog()"
              class="btn btn-success w-100"
            >
              Add Expense
            </button>
          </div>

          <div class="input-field ms-3">
            <input
              class="message-input"
              [(ngModel)]="messageInput"
              (keyup.enter)="sendMessage()"
              style="width: 100%"
              type="text"
              maxlength="512"
              (input)="onInputChange($event)"
              class="form-control"
              placeholder="Type something..."
            />
          </div>
          @if (charCountExceeded) {
            <div class="char-count error mx-2">{{ charCount }} / 512</div>
          }
          <button (click)="sendMessage()" class="send-message m-3">
            <i class="fa fa-paper-plane"></i>
          </button>
        </div>
      } @else {
        <div
          class="text-center p-2 d-flex flex-column justify-content-between"
          style="position: relative; flex: 1 1 0"
        >
          <h1 class="pt-2 animated-text">
            Welcome, <span>{{ user_name }}!</span>
          </h1>
          <img
            class="chat-box-image"
            (load)="onImageLoad()"
            [class.visible]="isImageLoaded"
            src="robot.gif"
            alt="robot"
          />
          <h3 class="pb-2 animated-text">
            Please select a chat to start messaging
          </h3>
        </div>
      }
    </div>
  </div>
</div>
